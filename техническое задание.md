# Техническое задание: модуль геообработки

## Цель
Разработать модуль для асинхронной обработки геопривязанных растровых и векторных файлов. Вход — ссылка/ID файла в модуле хранения файлов; выход — сгенерированный файл, загруженный обратно в модуль хранения (ссылка/ID).

## Поддерживаемые виды обработок
- Перепроецирование растров и векторов (изменение CRS).
- Изменение разрешения растров.

Файлы (входные и выходные) должны храниться и передаваться через `file_storage` (то есть модуль `task_manager` не оперирует «сырыми» данными в памяти, а использует ссылки/ID файлов).

## Асинхронная обработка
Обработки запускаются асинхронно: задача создаётся через API, помещается в очередь и выполняется воркером в фоне. Параметры обработки должны быть конфигурируемыми.

## Архитектура и компоненты

### `file_storage`
сервис хранения/доступа к файлам (приём/хранение/отдача файлов, управление метаданными). Все входные/выходные файлы проходят через него.


### `database`
персистентное хранилище состояний задач и метаданных (реляционная БД).
#### Таблицы
##### `tasks`

| Field | Type | Description |
|---|---|---|
| id | uuid | Уникальный идентификатор задачи |
| algorithm | enum | "GDAL_T_SRS" \| "GDAL_TR" \| "GDAL_OGR2OGR" |
| state | enum | "PENDING" \| "RUNNING" \| "DONE" \| "ERROR" | \| "STOPED" |
| input_file_id | uuid | Идентификатор входного файла в `file_storage` |
| params | json | Параметры алгоритма (структура зависит от `algorithm`) |
| datetime_expiration | datetime \| null | Время, до которого задача актуальна |
| output_file_id | uuid \| null | Идентификатор выходного файла в `file_storage` |
| output_file_name | string \| null | Предлагаемое имя выходного файла |
| output_file_path | string \| null | Предлагаемый путь/директория для выходного файла |
| output_file_extension | string \| null | Расширение выходного файла |
| datetime_create | datetime | Время создания задачи |
| datetime_start | datetime \| null | Время начала выполнения |
| datetime_end | datetime \| null | Время завершения |
| error | string \| null | Сообщение об ошибке (если есть) |
| error_code | int \| null | Числовой код ошибки (если есть) |

### `task_manager`
Необходим для создания и отслеживания задач (создание, просмотр статуса, отмена, повторный запуск и тд).

#### API

##### POST `/api/task`
Создание новой задачи.

###### Параметры:

| Field | Type | Description |
|---|---:|---|
| algorithm | enum | "GDAL_T_SRS" \| "GDAL_TR" \| "GDAL_OGR2OGR" |
| input_file_id | uuid | Идентификатор входного файла в `file_storage` |
| params | json | Параметры алгоритма (см. описание каждого алгоритма) |
| datetime_expiration | datetime \| null | Время, до которого задача актуальна |
| output_file_id | uuid \| null | Можно заранее указать место/идентификатор для результата |
| output_file_name | string \| null | Предпочитаемое имя выходного файла |
| output_file_path | string \| null | Предпочитаемый путь/директория для выходного файла |
| output_file_extension | string \| null | Желаемое расширение выходного файла |

###### Ответ
модель task из `database`

##### GET `/api/tasks/{id}`
получение информации о задаче (статус и информация о выполнении).

###### параметры:

| Field | Type | Description |
|---|---|---|
| id | string | Идентификатор задачи (UUID) |
###### Ответ
модель task из `database`

##### GET `/api/tasks/`
Получение информации о задаче (статус и информация о выполнении).

###### параметры:
Нету

###### Ответ
Список всех task из `database`

##### UPDATE `/api/tasks/{id}/stop`
Снятие задачи (если задача имеет статус `RUNNING`, результат не будет загружен в `file_storage`, если `PENDING` - не будет выполнена. Задача будет отмечена, как `STOPPED`)

###### параметры:

| Field | Type | Description |
|---|---|---|
| id | string | Идентификатор задачи (UUID) |

###### Ответ
модель task из `database`


##### UPDATE `/api/tasks/{id}/datetime_expiration`
Изменение времени актуальности задачи

###### параметры:

| Field | Type | Description |
|---|---|---|
| id | string | Идентификатор задачи (UUID) |
| datetime_expiration | datetime \| Время до которого задача актуальна | 


##### DELETE `/api/tasks/stoped`
Удаление отмененных задач. Из бд удаляются все задачи, помеченные как `STOPED`

##### DELETE `/api/tasks/expired`
Удаление неактуальных задач. Из бд удаляются все задачи, `expiration_time` которых истек

### `task_queue`
очередь задач, хранящая ID задач для асинхронной обработки.

### `worker`
фоновые процессы (воркеры), берущие задачи из очереди и выполняющие геообработку; по завершении загружают результат в `file_storage` и обновляют состояние задачи. Реализует в себе различные алгоритмы обработки файлов с параметрами

#### Алгоритмы обработки
##### Перепроецирование растров (gdalwarp -t_srs)
Изменяет проекцию растра
###### Параметры
```json
    "T_SRS": {
        "SRS_DEF": "str",
        "S_SRS": "str | none" 
    }
```
`SRS_DEF` - целевая проекция
`S_SRS` - проекция исходного файла (опционально, если в исходном файле недоступна проекция)

##### Изменение разрешения растра (gdalwarp -TR)
Изменяет разрешение растра
###### Параметры
```json
    "TR": {
        "XRES": "float",
        "YRES": "float",
    } | 
    {
        "SQUARE": true
    }
```
`XRES` - целевое разрешение по оси X
`YRES` - целевое разрешение по оси Y
`SQUARE` - сделать пиксели квадратными

##### перепроецирование векторных слоёв (ogr2ogr -t_srs)
Изменяет проекцию векторного слоя
###### Параметры
```json
    "T_SRS": {
        "SRS_DEF": "str",
        "S_SRS": "str | none" 
    }
```
`SRS_DEF` - целевая проекция
`S_SRS` - проекция исходного файла (опционально, если в исходном файле недоступна проекция)






## Поток данных
1. Пользователь загружает исходный файл в `file_storage` и получает `file_id`
2. Пользователь через `task_manager` создаёт задачу.
3. Задача сохраняется в `database` со статусом `PENDING` и ее `id` помещается в `task_queue`.
4. `worker` берёт `id` задачи из очереди, помечает её, как `RUNNING` в `database` и отмечает время `datetime_start`
5. `worker` загружает входной файл из `file_storage` по `input_file_id`
6. `worker` выбирает алгоритм, соответствующий `algorithm` и выполняет его с параметрами `params`
7. По завершении `worker` загружает выходной файл в `file_storage`, обновляет `output_file_id`, устанавливает `state` `DONE` и фиксирует время завершения; в случае ошибки — записывает `error` и `error_code`, устанавливает `state` `ERROR`.

## Используемые инструменты (GDAL)
- Перепроецирование растров и изменение разрешения: `gdalwarp` (опции `-t_srs` и `-tr`). Справка: https://gdal.org/en/stable/programs/gdalwarp.html
- Перепроецирование векторных слоёв: `ogr2ogr`. Справка: https://gdal.org/en/stable/programs/ogr2ogr.html




